---
title: "WT_Cis_CisplatinDoseResponse"
author: "David James"
date: "01/11/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(data.table)
library(ggplot2)
library(reshape2)
library(caret)
source("/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/RScripts_011122/cellPaintFunctions.r")
```

## RLoad datasets

```{r features to remove}
# Features to remove (because of NA columns or location parameters)

NACols <- c("AreaShape_NormalizedMoment_0_0_nuc", "AreaShape_NormalizedMoment_0_1_nuc",  "AreaShape_NormalizedMoment_1_0_nuc",  "AreaShape_NormalizedMoment_0_0_cell",
 "AreaShape_NormalizedMoment_0_1_cell", "AreaShape_NormalizedMoment_1_0_cell", "AreaShape_NormalizedMoment_0_0_cyto", "AreaShape_NormalizedMoment_0_1_cyto",
"AreaShape_NormalizedMoment_1_0_cyto",
"Location",
"Orientation",
"AreaShape_Center_.",
"AreaShape_BoundingBoxMaximum_",
"AreaShape_BoundingBoxMinimum_",
"AreaShape_EulerNumber_",
#"FileName",
'Number_Object_Number_nuc', 
'PathName', 
'Parent'
  )

```

## Load datasets

```{r, echo=FALSE, message=FALSE}

# Plate 1 WT
P1_WT <- load_CP_csv("/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/CellProfilerOutputs/headlessTest/P1/P1_Results/", 
                     prefix = "WT_", nucSuf = "FilteredNuclei", cellSuf = "Cell", cytoSuf = "Cytoplasm")

P1_WT_NucLocs <- nucLoc(P1_WT)
P1_WT <- rmColumns(P1_WT, NACols)
P1_WT <- cpMakeMeta("P1", list(c( "500", "2000", "5000", "10000", "20000", "40000", "80000"), c( "500", "2000", "5000", "10000", "20000", "40000", "80000"), 
                              c("1.25", "2.5", "5", "10", "20", "40", "80"), c("1.25", "2.5", "5", "10", "20", "40", "80"),
                              c("6.25", "12.5", "25", "50", "100", "200", "400"), c("6.25", "12.5", "25", "50", "100", "200", "400")), 
                 c("A", "A", "E", "E","F", "F"), P1_WT, 
                 "WT", 1:6, 
                 c("Cisplatin", "Cisplatin", "Dinaciclib", "Dinaciclib", "Doxorubicin", "Doxorubicin"))

# Plate 1 cis
P1_Cis <- load_CP_csv("/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/CellProfilerOutputs/RBGO_Storage/ResultsCisP01to04_09to12/P1/P1_Results/", 
                     prefix = "Cis_", nucSuf = "FilteredNuclei", cellSuf = "Cell", cytoSuf = "Cytoplasm")

P1_Cis_NucLocs <- nucLoc(P1_Cis)
P1_Cis <- rmColumns(P1_Cis, NACols)

P1_Cis <- cpMakeMeta("P1", list(c( "500", "2000", "5000", "10000", "20000", "40000", "80000"), c( "500", "2000", "5000", "10000", "20000", "40000", "80000"), 
                              c("1.25", "2.5", "5", "10", "20", "40", "80"), c("1.25", "2.5", "5", "10", "20", "40", "80"),
                              c("6.25", "12.5", "25", "50", "100", "200", "400"), c("6.25", "12.5", "25", "50", "100", "200", "400")), 
                 c("A", "A", "E", "E","F", "F"), P1_Cis, 
                 "Cis", 7:12, 
                 c("Cisplatin", "Cisplatin", "Dinaciclib", "Dinaciclib", "Doxorubicin", "Doxorubicin"))

# Plate 5 WT
P5_WT <- load_CP_csv("/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/CellProfilerOutputs/P5/P5_Results/", 
                     prefix = "WT_", nucSuf = "FilteredNuclei", cellSuf = "Cell", cytoSuf = "Cytoplasm")

P5_WT_NucLocs <- nucLoc(P5_WT)
P5_WT <- rmColumns(P5_WT, NACols)

P5_WT <- cpMakeMeta("P1", list(c( "500", "2000", "5000", "10000", "20000", "40000", "80000"), c( "500", "2000", "5000", "10000", "20000", "40000", "80000"), 
                              c("1.25", "2.5", "5", "10", "20", "40", "80"), c("1.25", "2.5", "5", "10", "20", "40", "80"),
                              c("6.25", "12.5", "25", "50", "100", "200", "400"), c("6.25", "12.5", "25", "50", "100", "200", "400")), 
                 c("A", "A", "E", "E","F", "F"), P5_WT, 
                 "WT", 7:12, 
                 c("Cisplatin", "Cisplatin", "Dinaciclib", "Dinaciclib", "Doxorubicin", "Doxorubicin"))

# Plate 5 Cis
P5_Cis <- load_CP_csv("/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/CellProfilerOutputs/P5/P5_Results/", 
                     prefix = "Cis_", nucSuf = "FilteredNuclei", cellSuf = "Cell", cytoSuf = "Cytoplasm")

P5_Cis_NucLocs <- nucLoc(P5_Cis)
P5_Cis <- rmColumns(P5_Cis, NACols)

P5_Cis <- cpMakeMeta("P1", list(c( "500", "2000", "5000", "10000", "20000", "40000", "80000"), c( "500", "2000", "5000", "10000", "20000", "40000", "80000"), 
                              c("1.25", "2.5", "5", "10", "20", "40", "80"), c("1.25", "2.5", "5", "10", "20", "40", "80"),
                              c("6.25", "12.5", "25", "50", "100", "200", "400"), c("6.25", "12.5", "25", "50", "100", "200", "400")), 
                 c("A", "A", "E", "E","F", "F"), P5_Cis, 
                 "Cis", 1:6, 
                 c("Cisplatin", "Cisplatin", "Dinaciclib", "Dinaciclib", "Doxorubicin", "Doxorubicin"))

# # Plate 6 WT
# P6_WT <- load_CP_csv("/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/CellProfilerOutputs/P6/P6_Results/", 
#                      prefix = "WT_", nucSuf = "FilteredNuclei", cellSuf = "Cell", cytoSuf = "Cytoplasm")
# 
# P6_WT_NucLocs <- nucLoc(P6_WT)
# P6_WT <- rmColumns(P6_WT, NACols)


# Plate 9 WT
P9_WT <- load_CP_csv("/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/CellProfilerOutputs/headlessTest/P9/P9_Results/", 
                     prefix = "WT_", nucSuf = "FilteredNuclei", cellSuf = "Cell", cytoSuf = "Cytoplasm")

P9_WT_NucLocs <- nucLoc(P9_WT)
P9_WT <- rmColumns(P9_WT, NACols)

P9_WT <- cpMakeMeta("P1", list(c( "500", "2000", "5000", "10000", "20000", "40000", "80000"), c( "500", "2000", "5000", "10000", "20000", "40000", "80000"), 
                              c("1.25", "2.5", "5", "10", "20", "40", "80"), c("1.25", "2.5", "5", "10", "20", "40", "80"),
                              c("6.25", "12.5", "25", "50", "100", "200", "400"), c("6.25", "12.5", "25", "50", "100", "200", "400")), 
                 c("A", "A", "E", "E","F", "F"), P9_WT, 
                 "WT", 1:6, 
                 c("Cisplatin", "Cisplatin", "Dinaciclib", "Dinaciclib", "Doxorubicin", "Doxorubicin"))

# Plate 9 Cis
P9_Cis <- load_CP_csv("/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/CellProfilerOutputs/RBGO_Storage/ResultsCisP01to04_09to12/P9/P9_Results/", 
                     prefix = "Cis_", nucSuf = "FilteredNuclei", cellSuf = "Cell", cytoSuf = "Cytoplasm")

P9_Cis_NucLocs <- nucLoc(P9_Cis)
P9_Cis <- rmColumns(P9_Cis, NACols)

P9_Cis <- cpMakeMeta("P1", list(c( "500", "2000", "5000", "10000", "20000", "40000", "80000"), c( "500", "2000", "5000", "10000", "20000", "40000", "80000"), 
                              c("1.25", "2.5", "5", "10", "20", "40", "80"), c("1.25", "2.5", "5", "10", "20", "40", "80"),
                              c("6.25", "12.5", "25", "50", "100", "200", "400"), c("6.25", "12.5", "25", "50", "100", "200", "400")), 
                 c("A", "A", "E", "E","F", "F"), P9_Cis, 
                 "Cis", 7:12, 
                 c("Cisplatin", "Cisplatin", "Dinaciclib", "Dinaciclib", "Doxorubicin", "Doxorubicin"))

metCols <- colnames(P1_WT)[1:11]
datCols <- colnames(P1_WT)[12:length(colnames(P1_WT))]
```
## Make DF of all cisplation treatments and untreated samples
```{r}

WT_CisplatinUntreated <- rbind(P1_WT[grepl("untreated|Cisplatin", P1_WT$Treatment), ], 
                               P5_WT[grepl("untreated|Cisplatin", P5_WT$Treatment), ],
                               P9_WT[grepl("untreated|Cisplatin", P9_WT$Treatment), ])

Cis_CisplatinUntreated <- rbind(P1_Cis[grepl("untreated|Cisplatin", P1_Cis$Treatment), ],
                                P5_Cis[grepl("untreated|Cisplatin", P5_Cis$Treatment), ],
                                P9_Cis[grepl("untreated|Cisplatin", P9_Cis$Treatment), ])

```

## Create datasets for SOM
```{r}

```

## SOM and MST





####### Older stuff!
## Get mean/median/sd/MAD for each plate
```{r}
## P1 WT
P1_WT_Med <- P1_WT[, datCols] %>%
  select(where(is.numeric)) %>%
  summarise(across(everything(), median))

P1_WT_Mad <- P1_WT[, datCols] %>%
  select(where(is.numeric)) %>%
  summarise(across(everything(),mad))

P1_WT_Med_UT <- P1_WT[P1_WT$Treatment == "untreated", datCols] %>%
  select(where(is.numeric)) %>%
  summarise(across(everything(), median))

P1_WT_Mad_UT <- P1_WT[P1_WT$Treatment == "untreated", datCols] %>%
  select(where(is.numeric)) %>%
  summarise(across(everything(), mad))

# P1 Cis
P1_Cis_Med <- P1_Cis[, datCols] %>%
  select(where(is.numeric)) %>%
  summarise(across(everything(), median))

P1_Cis_Mad <- P1_Cis[, datCols] %>%
  select(where(is.numeric)) %>%
  summarise(across(everything(),mad))

P1_Cis_Med_UT <- P1_Cis[P1_Cis$Treatment == "untreated", datCols] %>%
  select(where(is.numeric)) %>%
  summarise(across(everything(), median))

P1_Cis_Mad_UT <- P1_Cis[P1_Cis$Treatment == "untreated", datCols] %>%
  select(where(is.numeric)) %>%
  summarise(across(everything(), mad))

## P5
## P5 WT
P5_WT_Med <- P5_WT[, datCols] %>%
  select(where(is.numeric)) %>%
  summarise(across(everything(), median))

P5_WT_Mad <- P5_WT[, datCols] %>%
  select(where(is.numeric)) %>%
  summarise(across(everything(),mad))

P5_WT_Med_UT <- P5_WT[P5_WT$Treatment == "untreated", datCols] %>%
  select(where(is.numeric)) %>%
  summarise(across(everything(), median))

P5_WT_Mad_UT <- P5_WT[P5_WT$Treatment == "untreated", datCols] %>%
  select(where(is.numeric)) %>%
  summarise(across(everything(), mad))

# P5 Cis
P5_Cis_Med <- P5_Cis[, datCols] %>%
  select(where(is.numeric)) %>%
  summarise(across(everything(), median))

P5_Cis_Mad <- P5_Cis[, datCols] %>%
  select(where(is.numeric)) %>%
  summarise(across(everything(),mad))

P5_Cis_Med_UT <- P5_Cis[P5_Cis$Treatment == "untreated", datCols] %>%
  select(where(is.numeric)) %>%
  summarise(across(everything(), median))

P5_Cis_Mad_UT <- P5_Cis[P5_Cis$Treatment == "untreated", datCols] %>%
  select(where(is.numeric)) %>%
  summarise(across(everything(), mad))

```

## Compare nuclear parameters WT vs Cisplatin
```{r}

P1_Untreated <- rbind(P1_WT[P1_WT$Treatment == "untreated",], P1_Cis[P1_Cis$Treatment == "untreated",])
P1 <- rbind(P1_WT, P1_Cis)

### Compactness

WT_AreaShape_CompactnessUT <- plotMorphParamaterDist(P1_Untreated, 
                                                      "AreaShape_Compactness", 
                                                      c("nuc"), ttl = "Compactness Untreated P1", groupby = c("cell_line", "Metadata_Well_nuc"))

WT_AreaShape_CompactnessUT[[1]]



WT_AreaShape_Compactness <- plotMorphParamaterDist(P1, 
                                                      "AreaShape_Compactness", 
                                                      c("nuc"), ttl = "Compactness Untreated P1", groupby = c("cell_line", "Metadata_Well_nuc"))

WT_AreaShape_Compactness[[1]]

### Form factor

WT_AreaShape_FormFactorUT <- plotMorphParamaterDist(P1_Untreated, 
                                                      "AreaShape_FormFactor", 
                                                      c("nuc"), ttl = "Form factor untreated P1", groupby = c("cell_line", "Metadata_Well_nuc"))

WT_AreaShape_FormFactorUT[[1]]

WT_AreaShape_FormFactor <- plotMorphParamaterDist(P1, 
                                                      "AreaShape_FormFactor", 
                                                      c("nuc"), ttl = "Form Factor P1", groupby = c("cell_line", "Treatment", "Dose"))

WT_AreaShape_FormFactor[[1]]

## Diameter
WT_AreaShape_EquivalentDiameterUT <- plotMorphParamaterDist(P1_Untreated, 
                                                      "AreaShape_EquivalentDiameter", 
                                                      c("nuc"), ttl = "Equivalent diameter Untreated P1", groupby = c("cell_line", "Metadata_Well_nuc"))

WT_AreaShape_EquivalentDiameterUT[[1]]

## Major axis length
WT_AreaShape_MajorAxisLengthUT <- plotMorphParamaterDist(P1_Untreated, 
                                                      "AreaShape_MajorAxisLength", 
                                                      c("nuc"), ttl = "MajorAxisLength Untreated P1", groupby = c("cell_line", "Metadata_Well_nuc"))

WT_AreaShape_EquivalentDiameterUT[[1]]

```
## Cis nuclei
```{r}
library(randomForest)

cellClassdf <- data.frame(id = c(1, 2, 4, 5, 6, 7, 8, 9),
                  #classNuc = c("Smooth", "Kidney", "Irreg", "Triple", "Breaking", "Giant", "Elong", "Double"))
                  #classNuc = c("SmoothElong", "KidneyDouble", "IrregBreak", "Triple", "IrregBreak", "Giant", "SmoothElong", "KidneyDouble"))
                  classNuc = c("SmoothElongKidney", "SmoothElongKidney", "IrregBreak", "Triple", "IrregBreak", "Giant", "SmoothElongKidney", "Double"))

cisNucTrain <- read.csv("/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/CellNucleiType.csv", header = T)

cisNucTrainCnt <- cisNucTrain %>% dplyr::count(Nuclei.Type)
cisNucTrain$RowColFldCell <- paste(cisNucTrain$row, cisNucTrain$column, cisNucTrain$field, cisNucTrain$Cell.Number, sep = "_")

P1_RF_TrainParam <- colnames(P1_WT)[grepl("AreaShape.*nuc", colnames(P1_WT))]
P1_RF_TrainParam <- P1_RF_TrainParam[!grepl("Moment|Zernike", P1_RF_TrainParam)]
#P1_RF_TrainParam <- P1_RF_TrainParam[!grepl("Moment", P1_RF_TrainParam)]

P1_Cis_AreaShapeRF <- P1_Cis[P1_Cis$Treatment == "untreated", c(metCols,P1_RF_TrainParam)]
P1_Cis_AreaShapeRF$RowColFldCell <- paste(P1_Cis_AreaShapeRF$Metadata_Row_nuc, P1_Cis_AreaShapeRF$Metadata_Column_nuc, 
                                          P1_Cis_AreaShapeRF$Metadata_Site_nuc, P1_Cis_AreaShapeRF$ObjectNumber_nuc, sep = "_")

P1_Cis_NucTraining <- dplyr::inner_join(P1_Cis_AreaShapeRF, cisNucTrain, by = "RowColFldCell")

P1_Cis_NucTraining <- dplyr::left_join(P1_Cis_NucTraining, cellClassdf, by = c("Nuclei.Type" = "id"))
P1_Cis_NucTraining$classNuc <- factor(P1_Cis_NucTraining$classNuc, levels = unique(P1_Cis_NucTraining$classNuc))

## RF training
## Split data
set.seed(222)
ind <- sample(2, nrow(P1_Cis_NucTraining), replace = TRUE, prob = c(0.7, 0.3))
P1_CisNuc_train <- P1_Cis_NucTraining[ind==1,]
P1_CisNuc_test <- P1_Cis_NucTraining[ind==2,]

P1_CisNuc_rf <- randomForest(classNuc~., data=P1_CisNuc_train[,c(P1_RF_TrainParam, "classNuc")], proximity=TRUE) 

P1_CisNuc_rf_PredTrain <- predict(P1_CisNuc_rf, P1_CisNuc_train[, c(P1_RF_TrainParam, "classNuc")])
P1_CisNuc_rf_Pred <- predict(P1_CisNuc_rf, P1_CisNuc_test[, c(P1_RF_TrainParam, "classNuc")])

confusionMatrix(P1_CisNuc_rf_Pred, P1_CisNuc_test[, c(P1_RF_TrainParam, "classNuc")]$ classNuc)


## Test on WT
P1_WT_RF_Test <- P1_WT[P1_WT$Treatment == "untreated", c(metCols,P1_RF_TrainParam)]
P1_WT_RF_Predict <- predict(P1_CisNuc_rf, P1_WT_RF_Test[, c(P1_RF_TrainParam)])
```

## Self organizing map
```{r}
library(kohonen)
## SOM with raw normalized data ===================================================================================================================================================== ##

P1_RF_TrainParam_NoSize <- P1_RF_TrainParam[!grepl("Area_|Radius|Perimeter|ConvexArea|Diameter|Length", P1_RF_TrainParam)]

scaleMedMad <- function(x){(x - median(x))/mad(x)}
P1_Cis_NucTrainingNrm <- P1_Cis_NucTraining %>% mutate_at(P1_RF_TrainParam, scaleMedMad)

P1_Cis_NucTrainingNrmNoSz <- P1_Cis_NucTraining %>% mutate_at(P1_RF_TrainParam_NoSize, scaleMedMad)

## Do the som stuff
set.seed(222)
g <- somgrid(xdim = 3, ydim = 3, topo = "rectangular")
P1_CisNucMap <- som(as.matrix(P1_Cis_NucTrainingNrm[, P1_RF_TrainParam]), grid = g)

plot(P1_CisNucMap, type='codes', palette.name = rainbow)
plot(P1_CisNucMap, type = "mapping")

## Do SOM stuff no size constraints
set.seed(222)
P1_CisNucMapNoSz <- som(as.matrix(P1_Cis_NucTrainingNrm[, P1_RF_TrainParam_NoSize]), grid = g)

plot(P1_CisNucMapNoSz, type='codes', palette.name = rainbow)
plot(P1_CisNucMapNoSz, type = "mapping")



## SOM with best normal ===================================================================================================================================================== ##


# P1_Cis_NucTrainingNrm <- P1_Cis_NucTraining
# P1_Cis_NucTrainingNrm[P1_RF_TrainParam] <- dplyr:mutate(P1_Cis_NucTrainingNrm, )
  
  #

```
## Plot nuclei from SOM 
```{r, warning=FALSE}

library(imager)

cisNucSOM_Res <- cbind(P1_Cis_NucTrainingNrm[, metCols[1:9]], P1_CisNucMap$unit.classif)
cisNucSOM_Res <- dplyr::inner_join(cisNucSOM_Res, P1_Cis_NucLocs, by = c("Filename" = "FileName_DNA", "ObjectNumber_nuc" = "ObjectNumber_nuc"))

# cisNucSOM_ResNoSz <- cbind(P1_Cis_NucTrainingNrmNoSz[, metCols[1:9]], P1_CisNucMapNoSz$unit.classif)
# cisNucSOM_ResNoSz <- dplyr::inner_join(cisNucSOM_ResNoSz, P1_Cis_NucLocs, by = c("Filename" = "FileName_DNA", "ObjectNumber_nuc" = "ObjectNumber_nuc"))

nucPlot <- function(data, imDr, outDr, prefix = "", fn = "Filename", clses = "P1_CisNucMap$unit.classif", 
                    xLoc = "Location_Center_X_nuc", yLoc = "Location_Center_Y_nuc", imSufix = "_Cis.jpeg", objectNoDx = "ObjectNumber_nuc"){
  #browser()
  # Make image directories
  for (ix in unique(data[, clses])){
    
   dir.create(paste0(outDr, prefix, "_", ix))
    
  }
  # Make image patches
  for (dx in 1:nrow(data)){
    #browser()
    I <- load.image(file.path( imDr, gsub(".tif", imSufix,data$Filename[dx])))
 ## Nuclei images
    I1 <- imsub(I, x > round(max(1, data[dx,xLoc])) - 30 &
               x < round(min(1024, data[dx,xLoc])) + 30,
                y > round(max(1, data[dx,yLoc])) - 30 &
               y < round(min(1024, data[dx,yLoc])) + 30
               )
    #browser()
    save.image(I1, paste0(outDr, "/", prefix, "_", data[dx, clses],  
                         "/", gsub(".tif", paste0("NucDx_",
      data[dx, objectNoDx],  imSufix
    ),data$Filename[dx])
    ))
    
  ## Cell images
      I2 <- imsub(I, x > round(max(1025, 1024 + data[dx,xLoc])) - 50 &
               x < round(min(2*1024, 1024+data[dx,xLoc])) + 50,
                y > round(max(1, data[dx,yLoc])) - 50 &
               y < round(min(1024, data[dx,yLoc])) + 50
               )
      
         save.image(I2, paste0(outDr, "/", prefix, "_", data[dx, clses],  
                         "/", gsub(".tif", paste0("Cell_NucDx_",
      data[dx, objectNoDx],  imSufix
    ),data$Filename[dx])
    ))
    
    
  }
  
}


## plot with size
# nucPlot(cisNucSOM_Res, "/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/CellProfilerOutputs/RBGO_Storage/ResultsCisP01to04_09to12/P1/P1_SegmentationImages/",
#         outDr = "/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/R_Results/SOM_Predictions/SOM_InitialTest_CisUntreatedNucShape_NoMomNoZern/////", prefix = "CisUT_SOMTest")
  
# nucPlot(cisNucSOM_ResNoSz, "/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/CellProfilerOutputs/RBGO_Storage/ResultsCisP01to04_09to12/P1/P1_SegmentationImages/",
#         outDr = "/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/R_Results/SOM_Predictions/SOM_InitialTest_CisUntreatedNucShape_NoSz///", prefix = "CisUT_SOMTestNoSz", 
#         clses = "P1_CisNucMapNoSz$unit.classif")
```

## SOM on random Cisplatin nuclei and 

## Check to seperate multi nuc vs normal
```{r}
## Get the cisplatin 1000 randomly selected cells
set.seed(100)

n = 1000

P1_Cis_UT <- P1_Cis[P1_Cis$Treatment == "untreated",]

P1_is_UT_RndShape <- P1_Cis_UT[sample(nrow(P1_Cis_UT ),n), c(metCols, P1_RF_TrainParam)]
P1_is_UT_RndShapeNrm <- P1_is_UT_RndShape %>% mutate_at(P1_RF_TrainParam, scaleMedMad)

## SOM 
# g <- somgrid(xdim = 3, ydim = 3, topo = "rectangular")
# P1_is_UT_RndShapeNrmSOM <- som(as.matrix(P1_is_UT_RndShapeNrm[, P1_RF_TrainParam]), grid = g)
# 
# plot(P1_is_UT_RndShapeSOM, type='codes', palette.name = rainbow)
# plot(P1_is_UT_RndShapeSOM, type = "mapping")
# 
# ## Write cis SOM results to file
# 
# P1_is_UT_RndShapeSOM_Res <- cbind(P1_is_UT_RndShapeNrm[, metCols[1:9]], P1_is_UT_RndShapeSOM$unit.classif)
# P1_is_UT_RndShapeSOM_Res <- dplyr::inner_join(P1_is_UT_RndShapeSOM_Res, P1_Cis_NucLocs, by = c("Filename" = "FileName_DNA", "ObjectNumber_nuc" = "ObjectNumber_nuc"))
# 
# nucPlot(P1_is_UT_RndShapeSOM_Res, "/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/CellProfilerOutputs/RBGO_Storage/ResultsCisP01to04_09to12/P1/P1_SegmentationImages/",
#         outDr = "/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/R_Results/SOM_Predictions/CisRandomSelectionUntreated/", prefix = "CisUT_SOM_RandSelection", clses = "P1_is_UT_RndShapeSOM$unit.classif")



## Get the WT n randonly selected cells =========================================================================================================================================================== ###
set.seed(100)
P1_WT_UT <- P1_WT[P1_WT$Treatment == "untreated",]

P1_WT_UT_RndShape <- P1_WT_UT[sample(nrow(P1_WT_UT ),n), c(metCols, P1_RF_TrainParam)]
P1_WT_UT_RndShapeNrm <- P1_WT_UT_RndShape %>% mutate_at(P1_RF_TrainParam, scaleMedMad)

## SOM 
g <- somgrid(xdim = 3, ydim = 3, topo = "rectangular")
P1_WT_UT_RndShapeNrmSOM <- som(as.matrix(P1_WT_UT_RndShapeNrm[, P1_RF_TrainParam[!P1_RF_TrainParam == "AreaShape_MedianRadius_nuc"]]), grid = g) # the mad of the median nuclei radius is 0, therefore leave it out for now
# 
# plot(P1_WT_UT_RndShapeNrmSOM, type='codes', palette.name = rainbow)
# plot(P1_WT_UT_RndShapeNrmSOM, type = "mapping")
# 
# ## Write WT SOM results to file
# 
# P1_WT_UT_RndShapeNrmSOM_Res <- cbind(P1_WT_UT_RndShapeNrm[, metCols[1:9]], P1_WT_UT_RndShapeNrmSOM$unit.classif)
# P1_WT_UT_RndShapeNrmSOM_Res <- dplyr::inner_join(P1_WT_UT_RndShapeNrmSOM_Res, P1_WT_NucLocs, by = c("Filename" = "FileName_DNA", "ObjectNumber_nuc" = "ObjectNumber_nuc"))
# 
# nucPlot(P1_WT_UT_RndShapeNrmSOM_Res, "/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/CellProfilerOutputs/P1/P1_SegmentationImages/",
#         outDr = "/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/R_Results/SOM_Predictions/WTRandomSelectionUntreated//", prefix = "WTUT_SOM_RandSelection", clses = "P1_WT_UT_RndShapeNrmSOM$unit.classif", 
#         imSufix = "_WT.jpeg")

## Both WT and cis ============================================================================================================================================================================== #

P1_WT_Cis_UT_RndShape <- rbind(P1_WT_UT_RndShape, P1_is_UT_RndShape)
P1_WT_Cis_UT_RndShapeNrm <- P1_WT_Cis_UT_RndShape %>% mutate_at(P1_RF_TrainParam, scaleMedMad)

g <- somgrid(xdim = 3, ydim = 3, topo = "rectangular")
P1_WT_Cis_UT_RndShapeNrmSOM <- som(as.matrix(P1_WT_Cis_UT_RndShapeNrm [, P1_RF_TrainParam[!P1_RF_TrainParam == "AreaShape_MedianRadius_nuc"]]), grid = g) # the mad of the median nuclei radius is 0, therefore leave it out for now

plot(P1_WT_Cis_UT_RndShapeNrmSOM, type='codes', palette.name = rainbow)
plot(P1_WT_Cis_UT_RndShapeNrmSOM, type = "mapping")

P1_WT_Cis_UT_RndShapeNrmSOM_Res <- cbind(P1_WT_Cis_UT_RndShapeNrm[, metCols[1:9]], P1_WT_Cis_UT_RndShapeNrmSOM$unit.classif)
P1_WT_Cis_UT_RndShapeNrmSOM_ResWT <- P1_WT_Cis_UT_RndShapeNrmSOM_Res[P1_WT_Cis_UT_RndShapeNrmSOM_Res$cell_line == "WT", ]
P1_WT_Cis_UT_RndShapeNrmSOM_ResWT <- dplyr::inner_join(P1_WT_Cis_UT_RndShapeNrmSOM_ResWT, P1_WT_NucLocs, by = c("Filename" = "FileName_DNA", "ObjectNumber_nuc" = "ObjectNumber_nuc"))

P1_WT_Cis_UT_RndShapeNrmSOM_ResCis <- P1_WT_Cis_UT_RndShapeNrmSOM_Res[P1_WT_Cis_UT_RndShapeNrmSOM_Res$cell_line == "Cis", ]
P1_WT_Cis_UT_RndShapeNrmSOM_ResCis <- dplyr::inner_join(P1_WT_Cis_UT_RndShapeNrmSOM_ResCis  , P1_Cis_NucLocs, by = c("Filename" = "FileName_DNA", "ObjectNumber_nuc" = "ObjectNumber_nuc"))

# nucPlot(P1_WT_Cis_UT_RndShapeNrmSOM_ResWT, "/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/CellProfilerOutputs/P1/P1_SegmentationImages/",
#         outDr = "/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/R_Results/SOM_Predictions/WTCisRandomSelectionUntreated///", prefix = "WTCisUT_SOM_RandSelection", clses = "P1_WT_Cis_UT_RndShapeNrmSOM$unit.classif", 
#         imSufix = "_WT.jpeg")
# 
# nucPlot(P1_WT_Cis_UT_RndShapeNrmSOM_ResCis, "/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/CellProfilerOutputs/RBGO_Storage/ResultsCisP01to04_09to12/P1/P1_SegmentationImages/",
#         outDr = "/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/R_Results/SOM_Predictions/WTCisRandomSelectionUntreated///", prefix = "WTCisUT_SOM_RandSelection", clses = "P1_WT_Cis_UT_RndShapeNrmSOM$unit.classif", 
#         imSufix = "_Cis.jpeg")

```
## Minimal Spanning tree for SOM
```{r}

SOM_Dists <- dist(P1_WT_Cis_UT_RndShapeNrmSOM$codes[[1]])
SOM_dst_mat <- matrix(ncol = 3, nrow = length(SOM_Dists))

rowSOM_N <- nrow(SOM_Dists)
colSOM_N <- ncol(SOM_Dists)

rowSOM <- unlist(sapply(2:rowSOM_N, function(x){x:rowSOM_N}))
colSOM <- unlist(sapply(1:(rowSOM_N - 1), function(x){rep(x,(rowSOM_N - x) ) }))
  
cnt <- 1

for (dx in 1:length(SOM_Dists)){
  
  SOM_dst_mat[dx, ] <- c(colSOM[dx], rowSOM[dx], SOM_Dists[dx])
  
}

## Make spanning matrix
SOM_G <- graph.data.frame(SOM_dst_mat[,1:2] ,directed = FALSE)
plot(SOM_G, asp = 1)

E(SOM_G)$weight = SOM_dst_mat[,3]       # specify the actual weight
E(SOM_G)$label  = E(SOM_G)$weight # labels for the weight
V(SOM_G)$size = 15            # node size
plot(SOM_G, asp=0)

SOM_MST <- minimum.spanning.tree(SOM_G)
plot(SOM_MST)
```
# SOM for plate 5

```{r}

set.seed(100)

n = 1000

P5_Cis_UT <- P5_Cis[P5_Cis$Treatment == "untreated",]

P5_is_UT_RndShape <- P5_Cis_UT[sample(nrow(P5_Cis_UT ),n), c(metCols, P1_RF_TrainParam)]
P5_is_UT_RndShapeNrm <- P5_is_UT_RndShape %>% mutate_at(P1_RF_TrainParam, scaleMedMad)
# 
# ## SOM 
g <- somgrid(xdim = 3, ydim = 3, topo = "rectangular")
P5_is_UT_RndShapeNrmSOM <- som(as.matrix(P5_is_UT_RndShapeNrm[, P1_RF_TrainParam]), grid = g)

# plot(P5_is_UT_RndShapeNrmSOM, type='codes', palette.name = rainbow)
# plot(P5_is_UT_RndShapeNrmSOM, type = "mapping")

## Write cis SOM results to file

P5_is_UT_RndShapeSOM_Res <- cbind(P5_is_UT_RndShapeNrm[, metCols[1:9]], P5_is_UT_RndShapeNrmSOM$unit.classif)
P5_is_UT_RndShapeSOM_Res <- dplyr::inner_join(P5_is_UT_RndShapeSOM_Res, P5_Cis_NucLocs, by = c("Filename" = "FileName_DNA", "ObjectNumber_nuc" = "ObjectNumber_nuc"))

# nucPlot(P5_is_UT_RndShapeSOM_Res, "/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/CellProfilerOutputs/P5/P5_SegmentationImages/",
#         outDr = "/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/R_Results/SOM_Predictions/CisRandomSelectionUntreatedP5/", prefix = "CisUT_SOM_RandSelection", clses = "P5_is_UT_RndShapeNrmSOM$unit.classif")



## Get the WT n randonly selected cells =========================================================================================================================================================== ###
set.seed(100)
P5_WT_UT <- P5_WT[P5_WT$Treatment == "untreated",]

P5_WT_UT_RndShape <- P5_WT_UT[sample(nrow(P5_WT_UT ),n), c(metCols, P1_RF_TrainParam)]
P5_WT_UT_RndShapeNrm <- P5_WT_UT_RndShape %>% mutate_at(P1_RF_TrainParam, scaleMedMad)

## SOM 
g <- somgrid(xdim = 3, ydim = 3, topo = "rectangular")
P5_WT_UT_RndShapeNrmSOM <- som(as.matrix(P5_WT_UT_RndShapeNrm[, P1_RF_TrainParam[!P1_RF_TrainParam == "AreaShape_MedianRadius_nuc"]]), grid = g) # the mad of the median nuclei radius is 0, therefore leave it out for now
# 
# plot(P5_WT_UT_RndShapeNrmSOM, type='codes', palette.name = rainbow)
# plot(P5_WT_UT_RndShapeNrmSOM, type = "mapping")

## Write WT SOM results to file

P5_WT_UT_RndShapeNrmSOM_Res <- cbind(P5_WT_UT_RndShapeNrm[, metCols[1:9]], P5_WT_UT_RndShapeNrmSOM$unit.classif)
P5_WT_UT_RndShapeNrmSOM_Res <- dplyr::inner_join(P5_WT_UT_RndShapeNrmSOM_Res, P5_WT_NucLocs, by = c("Filename" = "FileName_DNA", "ObjectNumber_nuc" = "ObjectNumber_nuc"))

# nucPlot(P5_WT_UT_RndShapeNrmSOM_Res, "/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/CellProfilerOutputs/P5/P5_SegmentationImages/",
#         outDr = "/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/R_Results/SOM_Predictions/WTRandomSelectionUntreatedP5//", prefix = "WTUT_SOM_RandSelection", clses = "P5_WT_UT_RndShapeNrmSOM$unit.classif",
#         imSufix = "_WT.jpeg")

## Both WT and cis ============================================================================================================================================================================== #

P5_WT_Cis_UT_RndShape <- rbind(P5_WT_UT_RndShape, P5_is_UT_RndShape)
P5_WT_Cis_UT_RndShapeNrm <- P5_WT_Cis_UT_RndShape %>% mutate_at(P1_RF_TrainParam, scaleMedMad)

g <- somgrid(xdim = 3, ydim = 3, topo = "rectangular")
P5_WT_Cis_UT_RndShapeNrmSOM <- som(as.matrix(P5_WT_Cis_UT_RndShapeNrm [, P1_RF_TrainParam[!P1_RF_TrainParam == "AreaShape_MedianRadius_nuc"]]), grid = g) # the mad of the median nuclei radius is 0, therefore leave it out for now

plot(P5_WT_Cis_UT_RndShapeNrmSOM, type='codes', palette.name = rainbow)
plot(P5_WT_Cis_UT_RndShapeNrmSOM, type = "mapping")

P5_WT_Cis_UT_RndShapeNrmSOM_Res <- cbind(P5_WT_Cis_UT_RndShapeNrm[, metCols[1:9]], P5_WT_Cis_UT_RndShapeNrmSOM$unit.classif)
P5_WT_Cis_UT_RndShapeNrmSOM_ResWT <- P5_WT_Cis_UT_RndShapeNrmSOM_Res[P5_WT_Cis_UT_RndShapeNrmSOM_Res$cell_line == "WT", ]
P5_WT_Cis_UT_RndShapeNrmSOM_ResWT <- dplyr::inner_join(P5_WT_Cis_UT_RndShapeNrmSOM_ResWT, P5_WT_NucLocs, by = c("Filename" = "FileName_DNA", "ObjectNumber_nuc" = "ObjectNumber_nuc"))

P5_WT_Cis_UT_RndShapeNrmSOM_ResCis <- P5_WT_Cis_UT_RndShapeNrmSOM_Res[P5_WT_Cis_UT_RndShapeNrmSOM_Res$cell_line == "Cis", ]
P5_WT_Cis_UT_RndShapeNrmSOM_ResCis <- dplyr::inner_join(P5_WT_Cis_UT_RndShapeNrmSOM_ResCis  , P5_Cis_NucLocs, by = c("Filename" = "FileName_DNA", "ObjectNumber_nuc" = "ObjectNumber_nuc"))

# nucPlot(P5_WT_Cis_UT_RndShapeNrmSOM_ResWT, "/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/CellProfilerOutputs/P5/P5_SegmentationImages/",
#         outDr = "/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/R_Results/SOM_Predictions/WTCisRandomSelectionUntreatedP5///", prefix = "WTCisUT_SOM_RandSelection", clses = "P5_WT_Cis_UT_RndShapeNrmSOM$unit.classif",
#         imSufix = "_WT.jpeg")
# 
# nucPlot(P5_WT_Cis_UT_RndShapeNrmSOM_ResCis, "/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/CellProfilerOutputs/P5/P5_SegmentationImages/",
#         outDr = "/data/CEAT/ImageDatasets/CellPaint_WTCis_EpiCompoundDoseResponse/R_Results/SOM_Predictions/WTCisRandomSelectionUntreatedP5///", prefix = "WTCisUT_SOM_RandSelection", clses = "P5_WT_Cis_UT_RndShapeNrmSOM$unit.classif",
#         imSufix = "_Cis.jpeg")

```

## PCA
```{r}

pcaWTCisNucShape <- prcomp(P1_WT_Cis_UT_RndShapeNrm [, P1_RF_TrainParam[!P1_RF_TrainParam == "AreaShape_MedianRadius_nuc"]])

pcaWTCisNucShape$cell_line <- P1_WT_Cis_UT_RndShapeNrm$cell_line

ggplot(cbind(data.frame(pcaWTCisNucShape$x), P1_WT_Cis_UT_RndShapeNrm$cell_line), aes(x = PC1, y = PC2, color = `P1_WT_Cis_UT_RndShapeNrm$cell_line`)) + 
  geom_point(size = 0.02)

```


## Nuclei populations in Cisplatin treated cells
```{r}

P1_WT_Cis_UT_RndShapeNrmSOM_ResCount <- P1_WT_Cis_UT_RndShapeNrmSOM_Res %>% group_by(cell_line) %>% count(`P1_WT_Cis_UT_RndShapeNrmSOM$unit.classif`)

ggplot(P1_WT_Cis_UT_RndShapeNrmSOM_ResCount, aes(x = `P1_WT_Cis_UT_RndShapeNrmSOM$unit.classif`, 
                                                 y = n, fill = cell_line) ) +
  geom_col(position = 'dodge') + scale_x_continuous(breaks = 1:10)

P5_WT_Cis_UT_RndShapeNrmSOM_ResCount <- P5_WT_Cis_UT_RndShapeNrmSOM_Res %>% group_by(cell_line) %>% count(`P5_WT_Cis_UT_RndShapeNrmSOM$unit.classif`)

ggplot(P5_WT_Cis_UT_RndShapeNrmSOM_ResCount, aes(x = `P5_WT_Cis_UT_RndShapeNrmSOM$unit.classif`, 
                                                 y = n, fill = cell_line) ) +
  geom_col(position = 'dodge') + scale_x_continuous(breaks = 1:10)

```

## Aggregate data

```{r pressure, echo=FALSE}
P1_WT_Cis_UT_RndShapeNrmSOM_ResCount <- P1_WT_Cis_UT_RndShapeNrmSOM_Res %>% group_by(cell_line) %>% count(`P1_WT_Cis_UT_RndShapeNrmSOM$unit.classif`)

ggplot(P1_WT_Cis_UT_RndShapeNrmSOM_ResCount, aes(x = `P1_WT_Cis_UT_RndShapeNrmSOM$unit.classif`, 
                                                 y = n, fill = cell_line) ) +
  geom_col(position = 'dodge') + scale_x_continuous(breaks = 1:10)


```

## Look for false cell in WT and Cis
```{r}
library(knitr)
library(e1071)
P1_E_03_12 <- P1_WT[P1_WT$Filename == "P1_E - 03(fld 12 wv UV - DAPI).tif", c("ObjectNumber_nuc", P1_RF_TrainParam)]

P1_F_01_07 <- P1_WT[P1_WT$Filename == "P1_F - 01(fld 07 wv UV - DAPI).tif", c("ObjectNumber_nuc", P1_RF_TrainParam)]

badNucDx <- c(8, 3, 4, 27, 52, 60, 55, 53, 72, 10, 12, 3, 6, 4, 28, 40, 41, 19, 72, 54, 56, 35, 416, 421)

#kable(P1_E_03_12)

## SVM 
P1_E_03_12_SVM <- P1_E_03_12[, P1_RF_TrainParam]
P1_E_03_12_SVM$goodBad <- "Good"
P1_E_03_12_SVM$goodBad[badNucDx] <- "Bad"
P1_E_03_12_SVM$goodBad <- factor(P1_E_03_12_SVM$goodBad, levels = unique(P1_E_03_12_SVM$goodBad))

P1_E_03_12_SVM_Res <- svm(goodBad ~ ., data = P1_E_03_12_SVM, kernel = "linear", scale = FALSE)

# set.seed(10111)
# x = matrix(rnorm(40), 20, 2)
# y = rep(c(-1, 1), c(10, 10))
# x[y == 1,] = x[y == 1,] + 1
# plot(x, col = y + 3, pch = 19)
# dat = data.frame(x, y = as.factor(y))

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
